<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카드</title>
    <link rel="stylesheet" href="./card.css" />
</head>
<body>
    <!-- 
        [카드 맞추기]
        카드가 12장 있고, 2장씩 서로 앞면의 색 동일.
        게임이 시작되면 카드를 무작위로 섞어 배치한 뒤에 모든 카드의 앞면을 잠깐 표시.
        일정 시간 후에 카드가 모두 뒷면으로 돌아가면 카드를 2장씩 뒤집으며 확인.
        카드 12장을 모두 뒤집을 때까지 계속하고 카드의 짝을 모두 맞추면 끝.
     -->
    <div class="wrap">
        <div id="" data-value="1" class="card">
            <div class="card_front"></div>
            <div class="card_back"></div>
        </div>
        <div id="" data-value="" class="card ">
            <div class="card_front"></div>
            <div class="card_back"></div>
        </div>
        <div id="" data-value="" class="card ">
            <div class="card_front"></div>
            <div class="card_back"></div>
        </div>
        <div id="" data-value="" class="card ">
            <div class="card_front"></div>
            <div class="card_back"></div>
        </div>
        <div id="" data-value="" class="card ">
            <div class="card_front"></div>
            <div class="card_back"></div>
        </div>
        <div id="" data-value="" class="card ">
            <div class="card_front"></div>
            <div class="card_back"></div>
        </div>
    </div>

    <!-- 로딩 레이어 -->
    <div class="ly_pop ">
        <div class="txt">
            잠시 후 카드의 앞면을 볼 수 있습니다. <br>
            짝 맞추기 게임입니다. <br> 카드의 색상의 위치를 외워주세요.<br>
            카드의 앞면이 3초간 보였다가 닫힙니다.<br><br>
            <span class="txt_count">3</span>
        </div>
        <div class="dimm"></div>
    </div>

    <!-- 결과 창 레이어 -->
    <div class="result_pop">
        <div class="txt">짝짝짝! <br/>모두 맞추셨습니다.<br/>
            <button id="restartBtn">재시작</button>
        </div>
        <div class="dimm"></div>
    </div>

    <script>
        const cardList = document.querySelectorAll('.wrap .card'); // 카드요소
        let cardEndArr = []; // 완료 카드
        let cardChoiceArr = []; // 선택된 카드
        let cardColorArr = ['red', 'red', 'blue', 'blue','green','green']; // 색상코드
        const resultPopEl = document.querySelector('.result_pop'); // 결과 팝업
        const lyPopEl = document.querySelector('.ly_pop'); // 로딩 팝업

        // 카드 생성 
        // 뒷면이 처음에 보인다.
        if (cardList.length !== cardColorArr.length) {
            console.error("카드 리스트의 길이와 색상 배열의 길이가 맞지 않습니다.");
        } else {
            // 게임이 시작되면 카드를 무작위로 섞어 배치
            for(let i = 0; i < cardList.length; i++){
                // 무작위 인덱스 선택
                const deletedIndex = Math.floor(Math.random() * cardColorArr.length);
                
                // 선택된 색상을 data-value에 설정
                cardList[i].setAttribute('data-value', cardColorArr[deletedIndex]);

                // 선택된 색상을 class에 설정
                cardList[i].classList.add(cardColorArr[deletedIndex]);
                
                // 사용된 색상코드를 배열에서 제거
                cardColorArr.splice(deletedIndex, 1);
            }
        }

        // 카드 게임이 시작될 것을 팝업으로 알림
        lyPopEl.classList.add('active');

        // 2초 후 시작
        let count = 2;

        const countdown = setInterval(function() {
            let countEl = document.querySelector('.txt_count');
            countEl.textContent = count;
            count--;

            if (count < 0) {
                clearInterval(countdown);
                lyPopEl.classList.remove('active');
            }
        }, 1000);

        // 실행
        setTimeout(() => {
            // 함수 실행
            init();
        }, 3000)

        const init = () => {
            // 시작 팝업 닫기
            const lyPopEl = document.querySelector('.ly_pop');
            lyPopEl.classList.remove('active');

            // 모든 카드의 앞면을 잠깐 표시
            const cards = document.querySelectorAll('.card') // 카드 엘리먼트
            cards.forEach(card => card.classList.add('flipped'));

            setTimeout(() => {    
                const cardEventHandler = (event) => {
                    let target = event.currentTarget;
                    let targetDataColor = target.getAttribute('data-value');
                    target.classList.add('flipped');
                    target.classList.remove('active');

                    cardChoiceArr.push(targetDataColor);
                    cardEndArr.push(targetDataColor);
                    // 2장 뒤집혔을때 클릭 방지
                    if(cardChoiceArr.length === 2){
                        cards.forEach(card => {
                            card.removeEventListener('click', cardEventHandler);
                        })
                    }
                    // 뒤집은 2장이 같은 장이 아닐 경우
                    if(cardChoiceArr.length === 2 && cardChoiceArr[0] !== cardChoiceArr[1]){
                        cardEndArr.pop();
                        cardEndArr.pop();

                        cards.forEach(card => {
                            if(!cardEndArr.includes(card.getAttribute('data-value'))){
                                // 틀린 것만 뒤집기
                                setTimeout(() => {    
                                    card.classList.remove('flipped');
                                    card.addEventListener('click', cardEventHandler);
                                }, 1000);
                            }
                        })
                        cardChoiceArr = [];

                    } else if(cardChoiceArr.length === 2){ // 뒤집은 2장이 같은 장일 경우
                        cards.forEach(card => {
                            card.addEventListener('click', cardEventHandler);
                        })
                        cardChoiceArr = [];
                    } 
                    
                    if(cardEndArr.length === 6){ // 숫자 6 카드 개수
                        setTimeout(() => {    
                            cards.forEach(card => {
                                card.classList.remove('flipped');
                            })
                            resultPopEl.classList.add('active');
                        }, 1000);
                    }
                }

                cards.forEach(card => {
                    card.classList.remove('flipped');
                    card.classList.add('active');
                    card.addEventListener('click', cardEventHandler);
                });

            }, 3000);

            // 재시작 
            // 재시작 이슈. 재시작 버튼 후 제대로 게임 진행 안됨
            const restartBtn = document.querySelector('#restartBtn');
            const txtCount = document.querySelector('.txt_count');
            restartBtn.addEventListener('click', () => {
                resultPopEl.classList.remove('active');
                lyPopEl.classList.add('active');

                txtCount.innerHTML = 3;
                let count = 2;

                const countdown = setInterval(function() {
                    let countEl = document.querySelector('.txt_count');
                    countEl.textContent = count;
                    count--;

                    if (count < 0) {
                        clearInterval(countdown);
                        lyPopEl.classList.remove('active');
                    }
                }, 1000);

                setTimeout(() => {
                    // 함수 실행
                    init();
                }, 3000)

            });
        };
    </script>
</body>
</html>